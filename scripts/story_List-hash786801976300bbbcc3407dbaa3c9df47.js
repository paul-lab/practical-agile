
$(function(){var gstoryid=0;var tempdata='';var thisproject=$("div").find(".thisproject").prop("id");var thisiteration=$("div").find(".thisiteration").prop("id");var nlines=3;$("#"+nlines+"line").hide();showLines(nlines);var treelines=1
$('#1line').click(function(){showLines(1);});$('#2line').click(function(){showLines(2);});$('#3line').click(function(){showLines(3);});function showLines(n){switch(n){case 1:$("#1line").hide();$("#2line").show();$("#3line").show();$(".line-2-div").hide();$(".line-3-div").hide();nlines=1;return;case 2:$("#2line").hide();$("#1line").show();$("#3line").show();$(".line-2-div").hide();$(".line-3-div").show();nlines=2;return;default:$("#3line").hide();$("#1line").show();$("#2line").show();$(".line-2-div").show();$(".line-3-div").show();nlines=3;}}
$("#sortable-left, #sortable-right").sortable({connectWith:".connectedSortable"}).disableSelection();$('select[name="LIID"], select[name="RIID').change(function(){$('#SetIteration').submit();});$("#sortable").sortable({update:function(event,ui){if(ui.position.top>ui.originalPosition.top)
{rank='d';}else{rank='i';}
$.ajax({type:"GET",url:"update_storyorder.php",data:$("#sortable").sortable("serialize")+'&PID='+thisproject+'&AID='+ui.item[0].id.substring(6)+'&rank='+rank});}});$("#sortable-left, #sortable-right").sortable({update:function(event,ui){var LeftIID=$("div").find(".LIID").prop("id")*1;if(isNaN(LeftIID))
{LeftIID=0;}
var RightIID=$("div").find(".RIID").prop("id")*1;if(isNaN(RightIID))
{RightIID=0;}
if(ui.position.top>ui.originalPosition.top)
{rank='d';}else{rank='i';}
if(ui.position.left>ui.originalPosition.left)
{newiid=RightIID;oldiid=LeftIID;mov='ltr';}else{newiid=LeftIID;oldiid=RightIID;mov='rtl';}
if(newiid!=oldiid)
{if(newiid>0)
{$.ajax({type:"GET",url:"update_storyiteration.php",data:'PID='+thisproject+'&AID='+ui.item[0].id.substring(6)+'&IID='+newiid+'&OIID='+oldiid+'&mov='+mov,success:function(data){$("#rightsize").text(' Total: '+data+' pts.');}});}}
$.ajax({type:"GET",url:"update_storyorder.php",data:$("#sortable-left").sortable("serialize")+'&PID='+thisproject+'&AID='+ui.item[0].id.substring(6)+'&rank='+rank});$.ajax({type:"GET",url:"update_storyorder.php",data:$("#sortable-right").sortable("serialize")+'&PID='+thisproject+'&AID='+ui.item[0].id.substring(6)+'&rank='+rank});}});$("#sortable, #sortable-left, #sortable-right").sortable("option","handle",".storystatus");$("#status1, #status2, #status3, #status4,#status5, #status6,#status7, #status8,#status9, #status10").sortable({receive:function(event,ui){$.ajax({type:"GET",url:"update_boardstorystatus.php",data:'PID='+thisproject+'&AID='+ui.item.attr("id")+'&STAID='+this.id.substring(6)+'&IID='+$(this).attr("name")});},items:"li:not(.scrumtitle)",start:function(event,ui){},connectWith:".connectedSortable"}).disableSelection();$(".scrumdetail").dblclick(function(){window.location.href="story_Edit.php"+'?PID='+thisproject+'&AID='+$(this).attr("id")+'&IID='+thisiteration;});$(".storybox-div").dblclick(function(){window.location.href="story_Edit.php"+'?PID='+thisproject+'&AID='+$(this).attr("id").substring(8)+'&IID='+thisiteration;});$('.storybox-div').mouseover(function(){$('#menu_div_'+$(this).attr("id").substring(8)).css('visibility','visible');});$('.storybox-div').mouseout(function(){$('#menu_div_'+$(this).attr("id").substring(8)).css('visibility','hidden')});$('.storystatus').mouseover(function(){$('html, body').css("cursor","move");});$('.storystatus').mouseout(function(){$('html, body').css("cursor","default");});$('.statuspopup').mouseover(function(){$('html, body').css("cursor","pointer");});$('.statuspopup').mouseout(function(){$('html, body').css("cursor","default");});$('.storybox-div').click(function(){gstoryid=$(this).attr("id").substring(8);});$(".iterationdialog").dialog({autoOpen:false,resizable:false,modal:true});$('.iterationpopup').click(function(){$('.iterationdialog').dialog('open');$(".iterationdialog").dialog().dialog('widget').position({my:'left',at:'right',of:$(this)});});$('.iterationdialog .ui-button').click(function(){$('.iterationdialog').dialog('close');$.ajax({type:"GET",url:"update_storyiteration.php",data:'PID='+thisproject+'&AID='+gstoryid+'&IID='+$(this).attr('id')+'&OIID='+$(this).parent().attr("id").substring(5),success:function(){$('#story_'+gstoryid).hide();}});});$(".statusdialog").dialog({autoOpen:false,resizable:false,modal:true});$('.statuspopup').click(function(){$('.statusdialog').dialog('open');$(".statusdialog").dialog().dialog('widget').position({my:'left',at:'right',of:$(this)});});$('.statusdialog .ui-button').click(function(){var color=$(this).css("background-color");$('.statusdialog').dialog('close');$.ajax({type:"GET",url:"update_storystatus.php",data:'PID='+thisproject+'&AID='+gstoryid+'&SAID='+$(this).attr('id')+'&IID='+$(this).parent().attr("id").substring(6),success:function(data){$("#status_div"+gstoryid).text(data);$("#span_div"+gstoryid).css("background",color);$("#status_div"+gstoryid).css("background",color);}});});$('.quickview').click(function(){if($("#line-2-div"+$(this).prop("id").substring(9)).css("max-height")=="28px")
{$("#line-2-div"+$(this).prop("id").substring(9)).show();$("#line-3-div"+$(this).prop("id").substring(9)).show();$("#line-2-div"+$(this).prop("id").substring(9)).css("max-height","999em");}else{$("#line-2-div"+$(this).prop("id").substring(9)).css("max-height","28px");}});$(".tree").fancytree({extensions:["dnd"],activeVisible:true,aria:false,autoActivate:true,autoScroll:false,clickFolderMode:2,checkbox:false,debugLevel:0,fx:null,icons:false,keyboard:true,keyPathSeparator:"/",minExpandLevel:1,selectMode:1,tabbable:true,titlesTabbable:true,init:function(event,data,flag){$(".tree").fancytree("getRootNode").visit(function(node){node.setExpanded(true);});showLines(treelines);},activate:function(event,data){var node=data.node;$("#echoActive").text(node.title);},keydown:function(event,data){switch(event.which){case 32:data.node.toggleSelected();return false;}},dblclick:function(event,data){if(data.node.parent.data.key!='_1')window.location.href="story_Edit.php"+'?PID='+data.node.data.pid+'&AID='+data.node.key+'&IID='+data.node.data.iid;},dnd:{preventVoidMoves:true,preventRecursiveMoves:true,autoExpandMS:600,dragStart:function(node,data){goldparent=node.parent.data.key;if(node.data.nodndflag=='nodnd')
{return false;}else{return true;}},dragEnter:function(node,data){if(node.data.iteration!='Backlog')return'after';if(node.parent.data.key=='_1'){return false;}
return true;},dragDrop:function(node,data){updateit=true;if(data.hitMode+node.hasChildren()==="overfalse")
{updateit=confirm("You are creating a new Parent Story\n Is this really what you want to do?");}
if(updateit==true)
{goldparent=data.otherNode.parent.key;data.otherNode.moveTo(node,data.hitMode);if(data.hitMode=='over'){gnewparent=node.key;}else{gnewparent=node.parent.key;}
if(goldparent!=gnewparent){$.ajax({type:"GET",url:"update_storyparent.php",data:'PID='+thisproject+'&SID='+data.otherNode.key+'&NPAR='+gnewparent+'&OPAR='+goldparent,success:function(data){node.setExpanded(true);showLines(nlines);}});}
var dict=node.parent.toDict(true);var stories='';for(var pName in dict.children){stories=stories+'story[]='+dict.children[pName].key+'&';}
$.ajax({type:"GET",url:"update_epicstoryorder.php",data:stories});}}}});$(".btnCollapseAll").click(function(){$("#tree"+$(this).prop("id")).fancytree("getRootNode").visit(function(node){node.setExpanded(false);});});$(".btnExpandAll").click(function(){$("#tree"+$(this).prop("id")).fancytree("getRootNode").visit(function(node){node.setExpanded(true);});});});